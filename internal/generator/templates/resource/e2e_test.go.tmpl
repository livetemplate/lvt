package [[.PackageName]]

import (
	"fmt"
	"strings"
	"testing"
	"time"

	"github.com/chromedp/chromedp"
	lvttest "github.com/livetemplate/livetemplate/cmd/lvt/testing"
)

func Test[[.ResourceName]]E2E(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping E2E test in short mode")
	}

	// Setup test environment with automatic Chrome and server management
	test := lvttest.Setup(t, &lvttest.SetupOptions{
		AppPath: "../../cmd/[[.ModuleName]]/main.go",
	})
	defer test.Cleanup()

	// Navigate to resource page
	err := test.Navigate("/[[.ResourceNameLower]]")
	if err != nil {
		t.Fatalf("Failed to navigate: %v", err)
	}

	// Create assertion and CRUD helpers
	assert := lvttest.NewAssert(test)
	crud := lvttest.NewCRUDTester(test, "/[[.ResourceNameLower]]")

	t.Run("Initial Load", func(t *testing.T) {
		// Verify page loaded correctly
		if err := assert.PageContains("[[.ResourceName]] Management"); err != nil {
			t.Error(err)
		}

		// Verify WebSocket connection
		if err := assert.WebSocketConnected(); err != nil {
			t.Error(err)
		}

		// Verify no template errors
		if err := assert.NoTemplateErrors(); err != nil {
			t.Error(err)
		}

		// Verify no console errors
		if err := assert.NoConsoleErrors(); err != nil {
			t.Error(err)
			test.Console.PrintErrors()
		}

		t.Log("âœ… Initial page load verified")
	})

	t.Run("Add [[.ResourceName]]", func(t *testing.T) {
		// Create new [[.ResourceNameLower]] using CRUD helper
		err := crud.Create(
[[- range .Fields]]
[[- if eq .GoType "string"]]
			lvttest.TextField("[[.Name]]", "Test [[.Name | title]]"),
[[- else if eq .GoType "int64"]]
			lvttest.IntField("[[.Name]]", 42),
[[- else if eq .GoType "bool"]]
			lvttest.BoolField("[[.Name]]", true),
[[- else if eq .GoType "float64"]]
			lvttest.FloatField("[[.Name]]", 3.14),
[[- end]]
[[- end]]
		)
		if err != nil {
			t.Fatalf("Failed to create [[.ResourceNameLower]]: %v", err)
		}

		// Verify [[.ResourceNameLower]] was added
[[- range .Fields]]
[[- if eq .GoType "string"]]
		if err := crud.VerifyExists("Test [[.Name | title]]"); err != nil {
			t.Error(err)
		}
[[- end]]
[[- end]]

		t.Log("âœ… [[.ResourceName]] added successfully")
	})

	t.Run("Search [[.ResourceName]]s", func(t *testing.T) {
[[- $firstStringField := "" -]]
[[- range .Fields -]]
[[- if and (eq .GoType "string") (eq $firstStringField "") -]]
[[- $firstStringField = .Name -]]
		// Test search functionality
		var html string
		err := chromedp.Run(test.Context,
			chromedp.WaitVisible(`input[name="query"]`, chromedp.ByQuery),
			chromedp.Evaluate(`
				(() => {
					const input = document.querySelector('input[name="query"]');
					input.value = 'Test';
					input.dispatchEvent(new Event('input', { bubbles: true }));
				})();
			`, nil),
			chromedp.Sleep(1*time.Second),
			chromedp.OuterHTML(`section`, &html, chromedp.ByQuery),
		)

		if err != nil {
			t.Fatalf("Failed to search: %v", err)
		}

		if !strings.Contains(html, "Test") {
			t.Errorf("Search results not found")
		}

		t.Log("âœ… Search functionality works")
[[- end -]]
[[- end]]
	})

	t.Run("Console and Debugging", func(t *testing.T) {
		// Verify no console errors during operations
		if err := assert.NoConsoleErrors(); err != nil {
			t.Error(err)
			test.Console.PrintErrors()
		}

		// Log WebSocket activity for debugging
		t.Logf("WebSocket messages: sent=%d, received=%d",
			test.WebSocket.CountByDirection("sent"),
			test.WebSocket.CountByDirection("received"))
	})

	fmt.Println("\n" + strings.Repeat("=", 60))
	fmt.Println("ðŸŽ‰ All E2E tests passed!")
	fmt.Println(strings.Repeat("=", 60))
}
