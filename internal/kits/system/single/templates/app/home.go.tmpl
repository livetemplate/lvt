package home

import (
	"encoding/json"
	"net/http"
	"os"
	"time"

	"github.com/livetemplate/livetemplate"
)

// HomeController is a singleton that holds dependencies
type HomeController struct{}

// HomeState is pure data, cloned per session
type HomeState struct {
	Title        string     `json:"title"`
	AppName      string     `json:"app_name"`
	Resources    []Resource `json:"resources"`
	LastUpdated  string     `json:"last_updated"`
	CSSFramework string     `json:"-"`
}

type Resource struct {
	Name string `json:"name"`
	Path string `json:"path"`
	Type string `json:"type"`
}

// No action methods needed for home page (static)

// Handler creates an http.Handler for the home page
func Handler() http.Handler {
	resources := loadResources()

	// Controller is a singleton (no dependencies for home)
	controller := &HomeController{}

	// Initial state is pure data
	initialState := &HomeState{
		Title:        "[[.AppName]]",
		AppName:      "[[.AppName]]",
		Resources:    resources,
		LastUpdated:  formatTime(),
		CSSFramework: "[[.CSSFramework]]",
	}

	tmpl := livetemplate.New("home", livetemplate.WithDevMode([[.DevMode]]))
	return tmpl.Handle(controller, livetemplate.AsState(initialState))
}

func formatTime() string {
	return time.Now().Format("2006-01-02 15:04:05")
}

func loadResources() []Resource {
	data, err := os.ReadFile(".lvtresources")
	if err != nil {
		return []Resource{}
	}

	var resources []Resource
	if err := json.Unmarshal(data, &resources); err != nil {
		return []Resource{}
	}

	return resources
}
