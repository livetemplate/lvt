//go:build http

package [[.PackageName]]

import (
	"net/url"
	"testing"

	lvttest "github.com/livetemplate/lvt/testing"
)

// Test[[.ResourceName]]HTTP tests [[.ResourceName]] CRUD operations via HTTP requests.
// This provides fast, reliable testing without requiring a browser.
// For browser-specific behavior (WebSocket, JavaScript), use browser tests.
func Test[[.ResourceName]]HTTP(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping HTTP test in short mode")
	}

	// Setup HTTP test environment with automatic server management
	test := lvttest.SetupHTTP(t, &lvttest.HTTPSetupOptions{
		AppPath: "../../cmd/[[.ModuleName]]/main.go",
	})
	defer test.Cleanup()

	t.Run("Initial Load", func(t *testing.T) {
		// Get the resource page
		resp := test.Get("/[[.ResourceNameLower]]")

		// Create assertion helper
		assert := lvttest.NewHTTPAssert(resp)

		// Verify page loaded correctly
		assert.StatusOK(t)
		assert.ContentTypeHTML(t)

		// Verify page content
		assert.Contains(t, "[[.ResourceName]]")

		// Verify no template errors (unflattened expressions like {{.Field}})
		assert.NoTemplateErrors(t)

		// Verify form fields exist
[[- range .Fields]]
		assert.HasFormField(t, "[[.Name]]")
[[- end]]

		t.Log("✅ Initial page load verified")
	})

	t.Run("Add [[.ResourceName]]", func(t *testing.T) {
		// Submit form to add a new [[.ResourceNameLower]]
		formData := url.Values{}
[[- range .Fields]]
[[- if eq .GoType "string"]]
		formData.Set("[[.Name]]", "Test [[.Name | title]]")
[[- else if eq .GoType "int64"]]
		formData.Set("[[.Name]]", "42")
[[- else if eq .GoType "bool"]]
		formData.Set("[[.Name]]", "true")
[[- else if eq .GoType "float64"]]
		formData.Set("[[.Name]]", "3.14")
[[- else if eq .GoType "time.Time"]]
		formData.Set("[[.Name]]", "2024-01-15")
[[- end]]
[[- end]]

		// Submit the form
		resp := test.PostForm("/[[.ResourceNameLower]]", formData)

		// Should redirect or return success
		assert := lvttest.NewHTTPAssert(resp)
		if resp.StatusCode >= 300 && resp.StatusCode < 400 {
			// Follow redirect and verify content
			resp = test.FollowRedirect(resp)
			assert = lvttest.NewHTTPAssert(resp)
		}
		assert.StatusOK(t)

		// Get the list page to verify the [[.ResourceNameLower]] was added
		resp = test.Get("/[[.ResourceNameLower]]")
		assert = lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Verify [[.ResourceNameLower]] appears in the list
[[- range .Fields]]
[[- if eq .GoType "string"]]
		assert.Contains(t, "Test [[.Name | title]]")
[[- end]]
[[- end]]

		t.Log("✅ [[.ResourceName]] added successfully")
	})

[[- $firstStringField := "" -]]
[[- range .Fields -]]
[[- if and (eq .GoType "string") (eq $firstStringField "") -]]
[[- $firstStringField = .Name]]
	t.Run("Search [[$.ResourceName]]s", func(t *testing.T) {
		// Test search functionality via query parameter
		resp := test.Get("/[[$.ResourceNameLower]]?query=Test")

		assert := lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Search results should contain our test data
		assert.Contains(t, "Test")

		t.Log("✅ Search functionality works")
	})
[[- end -]]
[[- end]]

	t.Run("Form Validation", func(t *testing.T) {
		// Test form rendering
		resp := test.Get("/[[.ResourceNameLower]]")
		assert := lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Form should have submit button
		assert.HasElement(t, "button")

		// Verify no console/template errors in the response
		assert.NoTemplateErrors(t)

		t.Log("✅ Form validation passed")
	})
}
