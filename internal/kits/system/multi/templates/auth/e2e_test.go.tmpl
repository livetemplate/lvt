//go:build http

package auth

import (
	"net/url"
	"testing"

	lvttest "github.com/livetemplate/lvt/testing"
)

// TestAuthHTTP tests the authentication system via HTTP requests.
// This provides fast, reliable testing without requiring a browser.
// For browser-specific behavior (WebSocket, JavaScript), use browser tests.
func TestAuthHTTP(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping HTTP test in short mode")
	}

	// Setup HTTP test environment with automatic server management
	test := lvttest.SetupHTTP(t, &lvttest.HTTPSetupOptions{
		AppPath: "../../cmd/[[.ModuleName]]/main.go",
	})
	defer test.Cleanup()

	t.Run("Auth Page Loads", func(t *testing.T) {
		// Get the auth page
		resp := test.Get("/auth")

		// Create assertion helper
		assert := lvttest.NewHTTPAssert(resp)

		// Verify page loaded correctly
		assert.StatusOK(t)
		assert.ContentTypeHTML(t)

		// Verify login form elements exist
		assert.Contains(t, "Email")

		// Verify no template errors (unflattened expressions like [[.Field]])
		assert.NoTemplateErrors(t)

		// Verify form field exists
		assert.HasFormField(t, "Email")

		t.Log("✅ Auth page loaded successfully")
	})

[[- if .EnablePassword ]]
	t.Run("Registration Form Accessible", func(t *testing.T) {
		// Get the auth page
		resp := test.Get("/auth")

		assert := lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Verify registration option exists
		assert.Contains(t, "account")

		// Verify password field exists
		assert.HasFormField(t, "Password")

		t.Log("✅ Registration form accessible")
	})
[[- end ]]

	t.Run("Logout Endpoint Works", func(t *testing.T) {
		// Test logout endpoint
		resp := test.Get("/auth/logout")

		assert := lvttest.NewHTTPAssert(resp)

		// Should redirect to auth page
		if resp.StatusCode >= 300 && resp.StatusCode < 400 {
			location := resp.Header.Get("Location")
			if location == "" || (location != "/auth" && location != "/auth/") {
				t.Errorf("Expected redirect to /auth, got: %s", location)
			}
		} else {
			// If not redirect, should be OK
			assert.StatusOK(t)
		}

		t.Log("✅ Logout endpoint works")
	})

	t.Run("Form Inputs Present", func(t *testing.T) {
		// Get the auth page
		resp := test.Get("/auth")

		assert := lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Verify email input exists
		assert.HasFormField(t, "Email")

		// Form should have submit button
		assert.HasElement(t, "button")

		t.Log("✅ Form inputs present")
	})

[[- if .EnableMagicLink ]]
	t.Run("Magic Link Form", func(t *testing.T) {
		// Get the auth page
		resp := test.Get("/auth")

		assert := lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Verify magic link option exists (email-only login)
		assert.Contains(t, "email")

		t.Log("✅ Magic link form available")
	})
[[- end ]]

[[- if .EnableEmailConfirmation ]]
	t.Run("Email Confirmation Required", func(t *testing.T) {
		// Try to login with unconfirmed email
		formData := url.Values{}
		formData.Set("Email", "unconfirmed@example.com")
[[- if .EnablePassword ]]
		formData.Set("Password", "testpassword123")
[[- end ]]

		resp := test.PostForm("/auth/login", formData)

		// Should either show error or redirect
		assert := lvttest.NewHTTPAssert(resp)
		assert.NoTemplateErrors(t)

		t.Log("✅ Email confirmation check works")
	})
[[- end ]]

	t.Run("CSRF Protection", func(t *testing.T) {
		// Get the auth page to check for CSRF token
		resp := test.Get("/auth")

		assert := lvttest.NewHTTPAssert(resp)
		assert.StatusOK(t)

		// Verify CSRF token is present in the form
		assert.HasCSRFToken(t)

		t.Log("✅ CSRF protection in place")
	})
}
