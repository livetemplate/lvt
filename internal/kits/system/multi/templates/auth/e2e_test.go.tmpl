package auth

import (
	"context"
	"fmt"
	"os"
	"path/filepath"
	"strings"
	"testing"
	"time"

	"github.com/chromedp/chromedp"
	e2etest "github.com/livetemplate/lvt/testing"
)

// TestAuthE2E tests the authentication system end-to-end with a real browser
func TestAuthE2E(t *testing.T) {
	if testing.Short() {
		t.Skip("Skipping E2E test in short mode")
	}

	// Change to project root directory so the server can find template and database files
	origDir, err := os.Getwd()
	if err != nil {
		t.Fatalf("Failed to get working directory: %v", err)
	}
	if err := os.Chdir("../.."); err != nil {
		t.Fatalf("Failed to change to project root: %v", err)
	}
	t.Cleanup(func() { os.Chdir(origDir) })

	// Find the main.go file in cmd/*/
	mainGoPath := findMainGo(t)
	if mainGoPath == "" {
		t.Fatal("Could not find main.go in cmd/*/")
	}

	// Get free ports for server and Chrome debugging
	serverPort, err := e2etest.GetFreePort()
	if err != nil {
		t.Fatalf("Failed to get free port for server: %v", err)
	}

	debugPort, err := e2etest.GetFreePort()
	if err != nil {
		t.Fatalf("Failed to get free port for Chrome: %v", err)
	}

	// Start the application server
	serverCmd := e2etest.StartTestServer(t, mainGoPath, serverPort)
	defer func() {
		if serverCmd != nil && serverCmd.Process != nil {
			serverCmd.Process.Kill()
		}
	}()

	// Start Docker Chrome container
	e2etest.StartDockerChrome(t, debugPort)
	defer e2etest.StopDockerChrome(t, debugPort)

	// Connect to Docker Chrome via remote debugging
	chromeURL := fmt.Sprintf("http://localhost:%d", debugPort)
	allocCtx, allocCancel := chromedp.NewRemoteAllocator(context.Background(), chromeURL)
	defer allocCancel()

	ctx, cancel := chromedp.NewContext(allocCtx, chromedp.WithLogf(t.Logf))
	defer cancel()

	// Set timeout for the entire test (3 minutes to allow for all subtests)
	ctx, cancel = context.WithTimeout(ctx, 180*time.Second)
	defer cancel()

	t.Run("Auth Page Loads", func(t *testing.T) {
		var pageHTML string

		err := chromedp.Run(ctx,
			chromedp.Navigate(e2etest.GetChromeTestURL(serverPort)+"/auth"),
			chromedp.Sleep(2*time.Second), // Wait for page and client to load
			chromedp.OuterHTML(`body`, &pageHTML, chromedp.ByQuery),
		)

		if err != nil {
			t.Fatalf("Failed to load auth page: %v", err)
		}

		// Verify login form elements exist
		if !strings.Contains(pageHTML, "Email") {
			t.Error("Auth page doesn't contain email field")
		}
		lowerHTML := strings.ToLower(pageHTML)
		if !strings.Contains(lowerHTML, "sign in") {
			t.Error("Auth page doesn't contain sign in text")
		}

		t.Log("✅ Auth page loaded successfully")
	})

	{{- if .EnablePassword }}
	t.Run("Registration Form Accessible", func(t *testing.T) {
		var pageHTML string

		err := chromedp.Run(ctx,
			chromedp.Navigate(e2etest.GetChromeTestURL(serverPort)+"/auth"),
			chromedp.Sleep(2*time.Second),
			chromedp.OuterHTML(`body`, &pageHTML, chromedp.ByQuery),
		)

		if err != nil {
			t.Fatalf("Failed to load auth page: %v", err)
		}

		// Verify registration option exists
		if !strings.Contains(pageHTML, "account") {
			t.Error("Auth page doesn't have account creation option")
		}

		t.Log("✅ Registration form accessible")
	})
	{{- end }}

	t.Run("Logout Endpoint Works", func(t *testing.T) {
		var currentURL string

		// Navigate to logout
		err := chromedp.Run(ctx,
			chromedp.Navigate(e2etest.GetChromeTestURL(serverPort)+"/auth/logout"),
			chromedp.Sleep(1*time.Second),
			chromedp.Location(&currentURL),
		)

		if err != nil {
			t.Fatalf("Failed to test logout: %v", err)
		}

		// Should be redirected to home page (logout clears session and redirects to /)
		// The URL may be just "/" or contain "host.docker.internal" prefix
		if !strings.HasSuffix(currentURL, "/") && !strings.Contains(currentURL, "/?") {
			t.Errorf("Not redirected to home page after logout, got: %s", currentURL)
		}

		t.Log("✅ Logout endpoint works")
	})

	t.Run("Form Inputs Accept Values", func(t *testing.T) {
		var emailValue string

		err := chromedp.Run(ctx,
			chromedp.Navigate(e2etest.GetChromeTestURL(serverPort)+"/auth"),
			chromedp.Sleep(2*time.Second),
			chromedp.WaitVisible(`input[name="email"]`, chromedp.ByQuery),
			chromedp.SendKeys(`input[name="email"]`, "test@example.com", chromedp.ByQuery),
			chromedp.Value(`input[name="email"]`, &emailValue, chromedp.ByQuery),
		)

		if err != nil {
			t.Fatalf("Failed to interact with form: %v", err)
		}

		if !strings.Contains(emailValue, "test@example.com") {
			t.Errorf("Email input didn't accept value, got: %s", emailValue)
		}

		t.Log("✅ Form inputs accept values")
	})

	{{- if .EnablePassword }}
	t.Run("Switch to Registration Form", func(t *testing.T) {
		var pageHTML string

		err := chromedp.Run(ctx,
			chromedp.Navigate(e2etest.GetChromeTestURL(serverPort)+"/auth"),
			chromedp.Sleep(2*time.Second),
			// Click "Create account" button to switch to registration form
			chromedp.Click(`button[lvt-click="SwitchToRegister"]`, chromedp.ByQuery),
			chromedp.Sleep(2*time.Second),
			chromedp.OuterHTML(`body`, &pageHTML, chromedp.ByQuery),
		)

		if err != nil {
			t.Fatalf("Failed to switch to registration form: %v", err)
		}

		// Verify we're now on registration form
		lowerHTML := strings.ToLower(pageHTML)
		if !strings.Contains(lowerHTML, "create your account") {
			t.Errorf("Did not switch to registration form. Page content: %s", pageHTML[:min(500, len(pageHTML))])
		}

		t.Log("✅ Switch to registration form works")
	})

	t.Run("Registration Flow Works", func(t *testing.T) {
		var pageHTML string
		var heading string
		testEmail := fmt.Sprintf("test_%d@example.com", time.Now().UnixNano())

		// Navigate and ensure we're on login view first
		err := chromedp.Run(ctx,
			chromedp.Navigate(e2etest.GetChromeTestURL(serverPort)+"/auth"),
			chromedp.Sleep(2*time.Second),
			chromedp.TextContent(`h2`, &heading, chromedp.ByQuery),
		)
		if err != nil {
			t.Fatalf("Failed to navigate: %v", err)
		}

		// Only click SwitchToRegister if we're on the login form
		if strings.Contains(strings.ToLower(heading), "sign in") {
			err = chromedp.Run(ctx,
				chromedp.Click(`button[lvt-click="SwitchToRegister"]`, chromedp.ByQuery),
				chromedp.Sleep(3*time.Second),
			)
			if err != nil {
				t.Fatalf("Failed to switch to register: %v", err)
			}
		}

		// Fill in registration form and submit
		err = chromedp.Run(ctx,
			chromedp.Clear(`input[name="email"]`, chromedp.ByQuery),
			chromedp.SendKeys(`input[name="email"]`, testEmail, chromedp.ByQuery),
			chromedp.SendKeys(`input[name="password"]`, "testpassword123", chromedp.ByQuery),
			// Click the submit button (form has lvt-submit="Register")
			chromedp.Click(`form[lvt-submit="Register"] button[type="submit"]`, chromedp.ByQuery),
			chromedp.Sleep(3*time.Second),
			chromedp.OuterHTML(`body`, &pageHTML, chromedp.ByQuery),
		)

		if err != nil {
			t.Fatalf("Failed to complete registration: %v", err)
		}

		// Verify we got a success message or switched back to login
		lowerHTML := strings.ToLower(pageHTML)
		if !strings.Contains(lowerHTML, "account created") && !strings.Contains(lowerHTML, "sign in") {
			t.Errorf("Registration didn't show success or switch to login. Page content: %s", pageHTML[:min(500, len(pageHTML))])
		}

		t.Log("✅ Registration flow works")
	})
	{{- end }}
}

func min(a, b int) int {
	if a < b {
		return a
	}
	return b
}

// findMainGo finds the main.go file in cmd/*/
func findMainGo(t *testing.T) string {
	entries, err := os.ReadDir("cmd")
	if err != nil {
		t.Logf("Could not read cmd directory: %v", err)
		return ""
	}

	for _, entry := range entries {
		if entry.IsDir() {
			mainPath := filepath.Join("cmd", entry.Name(), "main.go")
			if _, err := os.Stat(mainPath); err == nil {
				return "./" + mainPath
			}
		}
	}
	return ""
}
